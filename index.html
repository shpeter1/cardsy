<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>🃏 השיטהאד של יצחקי 🃏</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:Arial,sans-serif; -webkit-tap-highlight-color:transparent; }
    body { background:linear-gradient(135deg,#2d5a27,#4a7c59); min-height:100vh; color:#fff; padding:10px; position:relative; }
    .game-container { max-width:800px; margin:20px auto; }
    .game-title { text-align:center; font-size:1.8rem; margin-bottom:10px; }
    .status {
      text-align:center;
      background:rgba(0,0,0,0.6);
      padding:8px;
      border-radius:5px;
      margin-bottom:10px;
    }
    .status.game-over {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      font-size:2rem;
      z-index:10;
    }
    .areas { display:grid; grid-template-columns:1fr 2fr 1fr; gap:10px; }
    .opponent-area, .player-area { background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; }
    .opponent-area h3, .player-area h3 { text-align:center; margin-bottom:8px; }
    .cards-container {
      display:flex; flex-wrap:wrap; gap:6px; justify-content:center;
    }
    /* enable scroll when too many cards */
    .player-area .cards-container {
      max-height:30vh; overflow-y:auto;
    }
    .card {
      pointer-events:auto;
      width:12vw; height:calc(12vw*1.5);
      min-width:40px; min-height:60px; max-width:60px; max-height:90px;
      background:#fff; border:1px solid #ccc; border-radius:4px;
      display:flex; align-items:center; justify-content:center;
      font-weight:bold; color:#333;
      touch-action:manipulation; user-select:none;
    }
    .card-back { background:linear-gradient(135deg,#1e3a8a,#3b82f6); color:transparent; }
    .selected { outline:3px solid #ffc107; }
    .center-area { background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; text-align:center; position:relative; }
    button { margin:4px; padding:8px 12px; border:none; border-radius:5px; font-size:1rem; }
    .btn-primary { background:#0d6efd; color:#fff; }
    .btn-secondary { background:#6c757d; color:#fff; }
    /* pile stacking */
    #pile { position:relative; width:12vw; height:calc(12vw*1.5); margin:0 auto; }
    #pile .card { position:absolute; top:0; left:0; margin:0; }
    @media (max-width:600px) { .areas { grid-template-columns:1fr!important; } }
    @media (orientation:landscape) and (max-width:900px) { .areas { grid-template-columns:1fr 1fr!important; } }
  </style>
</head>
<body>
  <div class="game-container">
    <h1 class="game-title">🃏 השיטהאד של יצחקי 🃏</h1>
    <div id="status" class="status">לחץ 'התחל משחק'</div>
    <div class="areas">
      <div class="opponent-area">
        <h3>🧔 יהודה</h3>
        <div id="oppClosed" class="cards-container"></div>
        <div id="oppOpen"   class="cards-container"></div>
        <div id="oppHand"   class="cards-container"></div>
      </div>
      <div class="center-area">
        <div>חפיסה: <span id="deckCount">0</span></div>
        <div id="pile" class="cards-container"></div>
        <button id="start" class="btn-primary">התחל משחק</button>
        <button id="restart" class="btn-primary" style="display:none">שחק מחדש</button>
        <button id="play"  class="btn-primary" disabled>שחק קלפים</button>
        <button id="take"  class="btn-secondary" disabled>קח ערימה</button>
      </div>
      <div class="player-area">
        <h3>👤 אתה</h3>
        <div id="plClosed" class="cards-container"></div>
        <div id="plOpen"   class="cards-container"></div>
        <div id="plHand"   class="cards-container"></div>
      </div>
    </div>
  </div>

  <audio id="winSound" src="win.mp3" preload="auto"></audio>

  <script>
    class Shithead {
      constructor() {
        this.suits=['♠','♥','♦','♣'];
        this.values=['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
        this.deck=[]; this.pile=[]; this.selected=[];
        this.player={closed:[],open:[],hand:[]};
        this.opp={closed:[],open:[],hand:[]};
        this.phase=0; this.turn='player';
        this.init();
      }

      init() {
        this.resetDeck();
        const startBtn = document.getElementById('start');
        const restartBtn = document.getElementById('restart');
        startBtn.onclick   = ()=>{ this.startGame(); startBtn.disabled=true; };
        restartBtn.onclick = ()=>{ window.location.reload(); };
        document.getElementById('play').onclick = ()=>this.playCards();
        document.getElementById('take').onclick = ()=>this.takePile();
        this.update();
      }

      resetDeck() {
        this.deck=[]; this.pile=[]; this.selected=[];
        this.player={closed:[],open:[],hand:[]};
        this.opp   ={closed:[],open:[],hand:[]};
        for(let s of this.suits) for(let v of this.values) this.deck.push({s,v});
        for(let i=this.deck.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [this.deck[i],this.deck[j]]=[this.deck[j],this.deck[i]];
        }
        this.phase=0; this.turn='player';
      }

      startGame() {
        for(let i=0;i<3;i++){
          this.player.closed.push(this.deck.pop());
          this.opp.closed.push(this.deck.pop());
        }
        for(let i=0;i<3;i++){
          this.player.open.push(this.deck.pop());
          this.opp.open.push(this.deck.pop());
        }
        for(let i=0;i<3;i++){
          this.player.hand.push(this.deck.pop());
          this.opp.hand.push(this.deck.pop());
        }
        this.phase=1; this.update();
      }

      renderZone(id, arr, hide, clickable) {
        const cont = document.getElementById(id);
        cont.innerHTML = '';
        arr.forEach(c=>{
          const d = document.createElement('div');
          d.className = 'card' + (hide ? ' card-back' : '');
          if(!hide) d.textContent = c.v+c.s;
          if(clickable){
            d.addEventListener('pointerdown', e=>{
              e.preventDefault();
              this.selectCard(c,d);
            },{passive:false});
          }
          cont.appendChild(d);
        });
      }

      update() {
        // check end-game
        const pCount = this.player.hand.length + this.player.open.length + this.player.closed.length;
        const oCount = this.opp.hand.length   + this.opp.open.length   + this.opp.closed.length;
        if(pCount===0 || oCount===0) {
          const status = document.getElementById('status');
          status.textContent = pCount===0 ? '🎉 ניצחת!' : '😢 הפסדת';
          status.classList.add('game-over');
          document.getElementById('winSound').play();
          document.getElementById('play').disabled=true;
          document.getElementById('take').disabled=true;
          document.getElementById('restart').style.display='inline-block';
          return;
        }

        document.getElementById('status').textContent = this.phase===0 ? 'לחץ להתחלת משחק' : 'תורך';
        document.getElementById('deckCount').textContent = this.deck.length;

        const noHand = this.player.hand.length===0;
        const noOpen = this.player.open.length===0;
        const revealClosed = noHand && noOpen && this.phase===1 && this.turn==='player';
        this.renderZone('plClosed', this.player.closed, !revealClosed, revealClosed);

        const canPlayOpen = noHand && this.phase===1 && this.turn==='player';
        this.renderZone('plOpen', this.player.open, false, canPlayOpen);

        const canPlayHand = this.phase===1 && this.turn==='player';
        this.renderZone('plHand', this.player.hand, false, canPlayHand);

        this.renderZone('oppClosed', this.opp.closed, true, false);
        this.renderZone('oppOpen',   this.opp.open,   true, false);
        this.renderZone('oppHand',   this.opp.hand,   true, false);

        this.renderZone('pile', this.pile, false, false);

        document.getElementById('play').disabled = this.selected.length===0;
        document.getElementById('take').disabled = this.selected.length>0;
      }
