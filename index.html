<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>🃏 השיטהאד של יצחקי 🃏</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:Arial,sans-serif; }
    body { background:linear-gradient(135deg,#2d5a27,#4a7c59); min-height:100vh; color:#fff; padding:10px; position:relative; }
    .game-container { max-width:800px; margin:20px auto; }
    .game-title { text-align:center; font-size:1.8rem; margin-bottom:10px; }
    .status {
      background:rgba(0,0,0,0.6); padding:8px; border-radius:5px;
      margin-bottom:10px; position:static; text-align:left; font-size:1rem;
    }
    .status.game-over {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%); font-size:2rem;
      text-align:center; margin-bottom:0; z-index:10;
    }
    .areas { display:grid; grid-template-columns:1fr 2fr 1fr; gap:10px; }
    .opponent-area, .player-area { background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; }
    .opponent-area h3, .player-area h3 { text-align:center; margin-bottom:8px; }
    .cards-container { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
    /* רק היד תגלול */
    #plHand { max-height:30vh; overflow-y:auto; }
    .card {
      width:12vw; height:calc(12vw*1.5);
      min-width:40px; min-height:60px; max-width:60px; max-height:90px;
      background:#fff; border:1px solid #ccc; border-radius:4px;
      display:flex; align-items:center; justify-content:center;
      font-weight:bold; color:#333; user-select:none;
      touch-action:manipulation; pointer-events:auto;
      position:relative;
    }
    .card-back { background:linear-gradient(135deg,#1e3a8a,#3b82f6); color:transparent; }
    .selected { outline:3px solid #ffc107; }
    .center-area {
      background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;
      position:relative;
    }
    #pile { position:relative; width:12vw; height:calc(12vw*1.5); margin:0 auto 10px; }
    #pile .card { position:absolute; top:0; left:0; }
    .controls {
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .controls-right {
      display:flex; flex-direction:column; gap:4px; align-items:flex-end;
    }
    .controls-left {
      display:flex; flex-direction:column; gap:4px; align-items:flex-start;
    }
    button { padding:8px 12px; border:none; border-radius:5px; font-size:1rem; }
    .btn-primary { background:#0d6efd; color:#fff; }
    .btn-secondary { background:#6c757d; color:#fff; }
    @media (max-width:600px) { .areas { grid-template-columns:1fr!important; } }
    @media (orientation:landscape) and (max-width:900px) { .areas { grid-template-columns:1fr 1fr!important; } }
  </style>
</head>
<body>
  <div class="game-container">
    <h1 class="game-title">🃏 השיטהאד של יצחקי 🃏</h1>
    <div id="status" class="status">לחץ 'התחל משחק'</div>
    <div class="areas">
      <div class="opponent-area">
        <h3>🧔 יהודה</h3>
        <div id="oppClosed" class="cards-container"></div>
        <div id="oppOpen"   class="cards-container"></div>
        <div id="oppHand"   class="cards-container"></div>
      </div>
      <div class="center-area">
        <div>חפיסה: <span id="deckCount">0</span></div>
        <div id="pile" class="cards-container"></div>
        <div class="controls">
          <div class="controls-left">
            <button id="play" class="btn-primary" disabled>שחק קלפים</button>
          </div>
          <div class="controls-right">
            <button id="start"   class="btn-primary">התחל משחק</button>
            <button id="restart" class="btn-primary" style="display:none">שחק מחדש</button>
            <button id="take"    class="btn-secondary" disabled>קח ערימה</button>
          </div>
        </div>
      </div>
      <div class="player-area">
        <h3>👤 אתה</h3>
        <div id="plClosed" class="cards-container"></div>
        <div id="plOpen"   class="cards-container"></div>
        <div id="plHand"   class="cards-container"></div>
      </div>
    </div>
  </div>

  <audio id="winSound" src="win.mp3" preload="auto"></audio>

  <script>
    class Shithead {
      constructor() {
        this.suits=['♠','♥','♦','♣'];
        this.values=['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
        this.init();
      }
      init() {
        this.resetState();
        document.getElementById('start').onclick   = ()=>{ this.startGame(); };
        document.getElementById('restart').onclick = ()=>{ this.resetState(); };
        document.getElementById('play').onclick    = ()=>this.playCards();
        document.getElementById('take').onclick    = ()=>this.takePile();
        this.update();
      }
      resetState() {
        this.deck=[]; this.pile=[]; this.selected=[];
        this.player={closed:[],open:[],hand:[]};
        this.opp   ={closed:[],open:[],hand:[]};
        for(let s of this.suits) for(let v of this.values) this.deck.push({s,v});
        for(let i=this.deck.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [this.deck[i],this.deck[j]]=[this.deck[j],this.deck[i]];
        }
        this.phase=0; this.turn='player';
        const status=document.getElementById('status');
        status.className='status';
        status.textContent="לחץ 'התחל משחק'";
        document.getElementById('restart').style.display='none';
        document.getElementById('play').disabled=true;
        document.getElementById('take').disabled=true;
      }
      startGame() {
        for(let i=0;i<3;i++){
          this.player.closed.push(this.deck.pop());
          this.opp.closed.push(this.deck.pop());
        }
        for(let i=0;i<3;i++){
          this.player.open.push(this.deck.pop());
          this.opp.open.push(this.deck.pop());
        }
        for(let i=0;i<3;i++){
          this.player.hand.push(this.deck.pop());
          this.opp.hand.push(this.deck.pop());
        }
        this.phase=1;
        document.getElementById('start').disabled=true;
        this.update();
      }
      renderZone(id, arr, hide, clickable) {
        const cont=document.getElementById(id);
        cont.innerHTML='';
        arr.forEach(c=>{
          const d=document.createElement('div');
          d.className='card'+(hide?' card-back':'');
          if(!hide) d.textContent=c.v+c.s;
          if(clickable){
            d.addEventListener('pointerdown', e=>this.select(c,d));
            d.addEventListener('click',        e=>this.select(c,d));
            d.addEventListener('touchstart',   e=>{ e.preventDefault(); this.select(c,d); },{passive:false});
          }
          cont.appendChild(d);
        });
      }
      update() {
        const status=document.getElementById('status');
        const pCount=this.player.hand.length+this.player.open.length+this.player.closed.length;
        const oCount=this.opp.hand.length+this.opp.open.length+this.opp.closed.length;
        if(pCount===0||oCount===0){
          status.textContent = pCount===0?'🎉 ניצחת!':'😢 הפסדת';
          status.classList.add('game-over');
          document.getElementById('winSound').play().catch(()=>{});
          document.getElementById('restart').style.display='inline-block';
          document.getElementById('play').disabled=true;
          document.getElementById('take').disabled=true;
          return;
        }
        status.textContent="תורך";
        document.getElementById('deckCount').textContent=this.deck.length;
        const noHand=this.player.hand.length===0;
        const noOpen=this.player.open.length===0;
        const revealClosed=noHand&&noOpen&&this.phase===1&&this.turn==='player';
        this.renderZone('plClosed',this.player.closed,!revealClosed,revealClosed);
        this.renderZone('plOpen',  this.player.open,  false, noHand&&this.phase===1&&this.turn==='player');
        this.renderZone('plHand',  this.player.hand,  false, this.phase===1&&this.turn==='player');
        this.renderZone('oppClosed',this.opp.closed,true,false);
        this.renderZone('oppOpen',  this.opp.open,  true,false);
        this.renderZone('oppHand',  this.opp.hand,  true,false);
        this.renderZone('pile',     this.pile,      false,false);
      }
      select(card,elem) {
        if(this.phase!==1||this.turn!=='player')return;
        const idx=this.selected.indexOf(card);
        if(idx>-1){
          this.selected.splice(idx,1);
          elem.classList.remove('selected');
        } else {
          this.selected.push(card);
          elem.classList.add('selected');
        }
        document.getElementById('play').disabled=this.selected.length===0;
        document.getElementById('take').disabled=this.selected.length>0;
      }
      val(c){return this.values.indexOf(c.v);}
      _burn() {
        ['hand','open','closed'].forEach(z=>{
          this.player[z]=this.player[z].filter(c=>!this.selected.includes(c));
        });
        this.selected=[]; this.pile=[];
        while(this.player.hand.length<3&&this.deck.length)
          this.player.hand.push(this.deck.pop());
        this.turn='player'; this.update();
      }
      playCards(){
        if(this.selected.some(c=>c.v==='10')){this._burn();return;}
        if(this.pile.length>=3){
          const combo=[...this.pile.slice(-3),...this.selected].slice(-4).map(c=>c.v);
          if(combo.length===4&&combo.every(v=>v===combo[0])){this._burn();return;}
        }
        if(this.selected.length>=4&&this.selected.every(c=>c.v===this.selected[0].v)){this._burn();return;}
        if(this.pile.length){
          const top=this.pile[this.pile.length-1];
          if(top.v!=='2'){
            if(!this.selected.every(c=>{
              if(c.v==='2'||c.v==='10')return true;
              if(top.v==='7')return this.val(c)<=this.val(top);
              return this.val(c)>=this.val(top);
            })){alert('לא ניתן לשחק');return;}
          }
        }
        this.pile.push(...this.selected);
        ['hand','open','closed'].forEach(z=>{
          this.player[z]=this.player[z].filter(c=>!this.selected.includes(c));
        });
        while(this.player.hand.length<3&&this.deck.length)
          this.player.hand.push(this.deck.pop());
        const played8=this.selected.some(c=>c.v==='8');
        this.selected=[];
        if(played8){
          this.turn='player';
          document.getElementById('status').textContent='התורך – 8 עצר את היריב';
          this.update();
        } else {
          this.turn='opp';
          this.update();
          setTimeout(()=>this.oppPlay(),500);
        }
      }
      takePile(){
        this.player.hand.push(...this.pile);
        this.pile=[]; this.turn='opp'; this.update();
        setTimeout(()=>this.oppPlay(),500);
      }
      oppPlay(){
        let avail=this.opp.hand.length?this.opp.hand:
                  this.opp.open.length?this.opp.open:
                                      this.opp.closed;
        let playable=avail.filter(c=>{
          if(!this.pile.length)return true;
          const top=this.pile[this.pile.length-1];
          if(top.v==='2')return true;
          if(c.v==='2'||c.v==='10')return true;
          if(top.v==='7')return this.val(c)<=this.val(top);
          return this.val(c)>=this.val(top);
        });
        if(!playable.length){
          this.opp.hand.push(...this.pile);
          this.pile=[]; this.turn='player'; this.update();return;
        }
        const card=playable.reduce((a,b)=>this.val(a)<this.val(b)?a:b);
        ['hand','open','closed'].forEach(z=>{
          const i=this.opp[z].indexOf(card);
          if(i>-1)this.opp[z].splice(i,1);
        });
        this.pile.push(card);
        if(card.v==='10'){this.pile=[];this.turn='player';this.update();return;}
        if(this.pile.length>=4){
          const last4=this.pile.slice(-4).map(c=>c.v);
          if(last4.every(v=>v===last4[0])){this.pile=[];this.turn='player';this.update();return;}
        }
        if(card.v==='8'){this.turn='opp';this.update();setTimeout(()=>this.oppPlay(),500);return;}
        while(this.opp.hand.length<3&&this.deck.length)
          this.opp.hand.push(this.deck.pop());
        this.turn='player';this.update();
      }
    }
    window.onload=()=>new Shithead();
  </script>
</body>
</html>
